# start with minimal installation

gentoo docache dosshd passwd=qwe # use default kernel, cache CD in RAM, start sshd with passwd as root password
# research maybe no framebuff is ok

# iwconfig on real machine

parted -a optimal /dev/sda # partition disk
> mklabel gpt # use GPT for sda
> unit mib # specify sizes in MB

# bios partition
> mkpart primary 1 3 # make primary partition from 1 to 3 MB
> name 1 grub
> set 1 bios_grub on

# boot partition
> mkpart primary 3 131
> name 2 boot
> set 2 boot on
> set 2 esp on # EFI System partition

# swap partition
> mkpart primary 131 643 # USE SAME AMOUNT AS RAM FOR HIBERNATE
> name 3 swap

# rootfs partition
> mkpart primary 643 -1 # START SHOULD BE SAME AS END OR SWAP PARTITION
> name 4 rootfs

> quit

# File system
mkfs.vfat /dev/sda1
mkfs.vfat /dev/sda2
mkfs.ext4 /dev/sda4

mkswap /dev/sda3
swapon /dev/sda3

# Mounting and preparing
mkdir /mnt/gentoo/boot
mount /dev/sda4 /mnt/gentoo
mount /dev/sda2 /mnt/gentoo/boot

date # Check that date is correct
date MMDDhhmmYYYY # set if needed

# Downloading installation
cd /mnt/gentoo
links https://www.gentoo.org/downloads/mirrors/ # arrows to find closest mirror, go to releases/amd64/autobuilds/current-stage3-amd64/
# select stage3-amd64-<release>.tar.bz2 and press d to download, then q to exit

# unpack downloaded file
tar xvjpf stage3-*.tar.bz2 --xattrs

# update /mnt/gentoo/etc/portage/make.conf set MAKEOPTS="-j5" where j is number of cores + 1. use CXXFLAGS from CFLAGS
# and set CFLAGS="-march=native -O2 -pipe"

# select closest mirrors
mirrorselect -i -o >> /mnt/gentoo/etc/portage/make.conf
mkdir /mnt/gentoo/etc/portage/repos.conf
cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
cp -L /etc/resolv.conf /mnt/gentoo/etc/ # copy DNS

# mounting system folders
mount -t proc proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys # required for systemd
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev # required for systemd

# changing root to installed gentoo
chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1="(chroot) $PS1" # optional to see chrooting

# installing package manager
emerge-webrsync

# make an alias for 'emerge --sync' to sync package manager
# select profile if needed (not needed right now)
emerge --ask --update --deep --newuse @world # install packages for selected profile

# cleanup USE variable for emerge

ls /usr/share/zoneinfo # find available timezone
echo "Europe/Amsterdam" > /etc/timezone # save it
emerge --config sys-libs/timezone-data # apply it

nano -w /etc/locale.gen # write en_US and ru_RU
locale-gen # apply localization
eselect locale list # display available locales
eselect locale set 5 # select desired locale by number
env-update && source /etc/profile && export PS1="(chroot) $PS1" # reload settings

# installing kernel
emerge --ask sys-kernel/gentoo-sources # choose kernel at https://wiki.gentoo.org/wiki/Kernel/Overview
